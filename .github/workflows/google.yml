
name: Build 

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GAR_LOCATION: us-central1 # TODO: update region of the Artifact Registry
  GKE_CLUSTER: cluster-1    # TODO: update to cluster name
  GKE_ZONE: us-central1-c   # TODO: update to cluster zone
  DEPLOYMENT_NAME: gke-test # TODO: update to deployment name
  REPOSITORY: samples # TODO: update to Artifact Registry docker repository
  IMAGE: static-site

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
     - name: Checkout
       uses: actions/checkout@v3
        
     - name: cacheMxe
       id: cacheMxe
       uses: actions/cache@v1
       with:
        path: mxe
        key: ${{ runner.os }}-mxe-${{ hashFiles('.github/build-mxe.sh') }}
        
     - if: ${{ steps.cacheMxe.outputs.cache-hit != 'true' }}
       name: rebuildmxe
       run: sh .github/build-mxe.sh

   
   

    # build mxe
    # - name: Build mxe 
    #   run: |-
    #    docker build  -f "Docker/DockerFile" -t sigrokmxe:latest "Docker"
    #    docker run -v $PWD/mxe:/a sigrokmxe:latest sh -c "cp -a /work/mxe/usr /a/usr"
    # - name: Upload work
    #   uses: actions/upload-artifact@main
    #   with:
    #     name: mxe
    #     path: mxe/usr
   
